/**
 * Hook de gestion de l'int√©gration Google Drive
 * Authentification, sauvegarde et chargement des donn√©es
 */

const { useState, useEffect, useCallback } = React;

export const useGoogleDrive = () => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [isInitialized, setIsInitialized] = useState(false);
    const [isSyncing, setIsSyncing] = useState(false);
    const [lastSync, setLastSync] = useState(null);
    const [error, setError] = useState(null);

    // Configuration Google Drive - avec fallbacks s√©curis√©s
    const GOOGLE_CLIENT_ID = (typeof process !== 'undefined' && process.env?.GOOGLE_CLIENT_ID) || 'demo-mode';
    const GOOGLE_API_KEY = (typeof process !== 'undefined' && process.env?.GOOGLE_API_KEY) || 'demo-mode';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DATA_FILE_NAME = 'c-secur360-planificateur-data.json';
    
    // V√©rifier si Google Drive est disponible
    const isGoogleDriveAvailable = GOOGLE_CLIENT_ID !== 'demo-mode' && GOOGLE_API_KEY !== 'demo-mode';

    // ============== INITIALISATION GOOGLE API ==============
    const initializeGoogleAPI = async () => {
        // Si Google Drive n'est pas configur√©, ne pas essayer d'initialiser
        if (!isGoogleDriveAvailable) {
            console.log('‚ÑπÔ∏è Google Drive en mode d√©mo - credentials non configur√©s');
            setError('Configuration Google Drive requise');
            setIsInitialized(true); // Marquer comme initialis√© pour √©viter les boucles
            return;
        }
        
        // V√©rifier que les APIs Google sont charg√©es
        if (typeof gapi === 'undefined' || typeof google === 'undefined') {
            console.warn('‚ö†Ô∏è APIs Google non disponibles');
            setError('APIs Google non disponibles');
            setIsInitialized(true);
            return;
        }

        try {
            console.log('üöÄ Initialisation Google Drive API...');
            
            // Initialiser gapi avec timeout
            await Promise.race([
                new Promise((resolve) => {
                    gapi.load('client', resolve);
                }),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout gapi.load')), 5000)
                )
            ]);

            await Promise.race([
                gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                }),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout gapi.client.init')), 5000)
                )
            ]);

            // Initialiser Google Identity Services
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.access_token) {
                        setIsAuthenticated(true);
                        setError(null);
                        console.log('‚úÖ Authentification Google Drive r√©ussie');
                    }
                },
            });

            window.googleTokenClient = tokenClient;
            setIsInitialized(true);
            console.log('‚úÖ Google Drive API initialis√©e');
            
            // V√©rifier si l'utilisateur est d√©j√† connect√©
            if (gapi.client.getToken()) {
                setIsAuthenticated(true);
            }

        } catch (error) {
            console.error('‚ùå Erreur initialisation Google Drive:', error);
            setError('Google Drive indisponible');
            setIsInitialized(true); // Marquer comme initialis√© m√™me en cas d'erreur
        }
    };

    // ============== AUTHENTIFICATION ==============
    const signIn = useCallback(() => {
        if (!isGoogleDriveAvailable) {
            setError('Configuration Google Drive requise');
            return;
        }
        
        if (!isInitialized) {
            setError('Google Drive pas encore initialis√©');
            return;
        }
        
        try {
            console.log('üîê Demande de connexion Google Drive...');
            if (window.googleTokenClient) {
                window.googleTokenClient.requestAccessToken();
            } else {
                throw new Error('Token client non disponible');
            }
        } catch (error) {
            console.error('‚ùå Erreur connexion Google Drive:', error);
            setError('Erreur de connexion');
        }
    }, [isGoogleDriveAvailable, isInitialized]);

    const signOut = useCallback(() => {
        try {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    console.log('üö™ D√©connexion Google Drive');
                });
                gapi.client.setToken(null);
            }
            setIsAuthenticated(false);
            setLastSync(null);
        } catch (error) {
            console.error('‚ùå Erreur d√©connexion Google Drive:', error);
        }
    }, []);

    // ============== GESTION DES FICHIERS ==============
    const findDataFile = async () => {
        try {
            const response = await gapi.client.drive.files.list({
                q: `name='${DATA_FILE_NAME}' and trashed=false`,
                spaces: 'drive',
                fields: 'files(id, name, modifiedTime)',
            });

            const files = response.result.files;
            return files && files.length > 0 ? files[0] : null;
        } catch (error) {
            console.error('‚ùå Erreur recherche fichier:', error);
            throw error;
        }
    };

    const saveToGoogleDrive = async (data) => {
        if (!isAuthenticated) {
            throw new Error('Non connect√© √† Google Drive');
        }

        setIsSyncing(true);
        setError(null);

        try {
            console.log('üíæ Sauvegarde vers Google Drive...');
            const dataToSave = {
                ...data,
                syncedAt: new Date().toISOString(),
                version: '6.7'
            };

            // Rechercher le fichier existant
            const existingFile = await findDataFile();
            const fileContent = JSON.stringify(dataToSave, null, 2);
            const metadata = {
                name: DATA_FILE_NAME,
                parents: undefined, // Sauvegarder √† la racine
            };

            let response;
            if (existingFile) {
                // Mettre √† jour le fichier existant
                response = await gapi.client.request({
                    path: `https://www.googleapis.com/upload/drive/v3/files/${existingFile.id}`,
                    method: 'PATCH',
                    params: {
                        uploadType: 'multipart'
                    },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="foo_bar_baz"'
                    },
                    body: `--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(metadata)}\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n${fileContent}\r\n--foo_bar_baz--`
                });
            } else {
                // Cr√©er un nouveau fichier
                response = await gapi.client.request({
                    path: 'https://www.googleapis.com/upload/drive/v3/files',
                    method: 'POST',
                    params: {
                        uploadType: 'multipart'
                    },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="foo_bar_baz"'
                    },
                    body: `--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(metadata)}\r\n--foo_bar_baz\r\nContent-Type: application/json\r\n\r\n${fileContent}\r\n--foo_bar_baz--`
                });
            }

            setLastSync(new Date());
            console.log('‚úÖ Donn√©es sauvegard√©es sur Google Drive');
            return response.result;

        } catch (error) {
            console.error('‚ùå Erreur sauvegarde Google Drive:', error);
            setError('Erreur de sauvegarde');
            throw error;
        } finally {
            setIsSyncing(false);
        }
    };

    const loadFromGoogleDrive = async () => {
        if (!isAuthenticated) {
            return null;
        }

        setIsSyncing(true);
        setError(null);

        try {
            console.log('üì• Chargement depuis Google Drive...');
            const file = await findDataFile();
            
            if (!file) {
                console.log('‚ÑπÔ∏è Aucun fichier de donn√©es trouv√© sur Google Drive');
                return null;
            }

            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });

            const data = JSON.parse(response.body);
            setLastSync(new Date());
            console.log('‚úÖ Donn√©es charg√©es depuis Google Drive');
            return data;

        } catch (error) {
            console.error('‚ùå Erreur chargement Google Drive:', error);
            setError('Erreur de chargement');
            return null;
        } finally {
            setIsSyncing(false);
        }
    };

    // ============== SYNCHRONISATION FORC√âE ==============
    const forceSync = async (localData) => {
        if (!isAuthenticated) {
            setError('Non connect√© √† Google Drive');
            return false;
        }

        try {
            await saveToGoogleDrive(localData);
            return true;
        } catch (error) {
            return false;
        }
    };

    // ============== INITIALISATION ==============
    useEffect(() => {
        // Approche d√©fensive pour l'initialisation Google Drive
        const safeInitialize = async () => {
            try {
                // V√©rification approfondie de la disponibilit√© des APIs
                if (typeof gapi === 'undefined' || typeof google === 'undefined') {
                    console.warn('‚ö†Ô∏è APIs Google non disponibles - fonctionnement en mode local');
                    setError('APIs Google non charg√©es');
                    setIsInitialized(true);
                    return;
                }

                // V√©rifier que les objects gapi et google sont compl√®tement charg√©s
                if (!gapi.load || !google.accounts) {
                    console.warn('‚ö†Ô∏è APIs Google incompl√®tement charg√©es');
                    setError('APIs Google non pr√™tes');
                    setIsInitialized(true);
                    return;
                }

                // Si tout est OK, initialiser
                await initializeGoogleAPI();
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation s√©curis√©e:', error);
                setError('Erreur d\'initialisation Google Drive');
                setIsInitialized(true);
            }
        };

        // D√©lai pour s'assurer que les scripts Google sont compl√®tement charg√©s
        const initTimer = setTimeout(safeInitialize, 100);
        
        return () => clearTimeout(initTimer);
    }, []);

    return {
        isAuthenticated,
        isInitialized,
        isSyncing,
        lastSync,
        error,
        isGoogleDriveAvailable,
        signIn,
        signOut,
        saveToGoogleDrive,
        loadFromGoogleDrive,
        forceSync,
        findDataFile
    };
};