<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Debug Test - C-Secur360</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    <div id="error-log"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const errorDiv = document.getElementById('error-log');
            errorDiv.innerHTML += `<div style="background: red; color: white; padding: 10px; margin: 5px;">
                ERREUR: ${msg}<br>
                Ligne: ${lineNo}, Colonne: ${columnNo}<br>
                ${error?.stack || ''}
            </div>`;
            return false;
        };

        const TestApp = () => {
            const [etapes, setEtapes] = useState([
                { id: 1, text: 'Test étape 1', duration: 2, personnelRequis: 2, personnel: [], isParallel: false },
                { id: 2, text: 'Test étape 2', duration: 1, personnelRequis: 1, personnel: [], isParallel: false }
            ]);
            
            const [showParallelSelector, setShowParallelSelector] = useState(null);
            
            const moveEtapeUp = useCallback((index) => {
                if (index > 0) {
                    const newEtapes = [...etapes];
                    [newEtapes[index - 1], newEtapes[index]] = [newEtapes[index], newEtapes[index - 1]];
                    setEtapes(newEtapes);
                    console.log('Déplacé vers le haut:', index);
                }
            }, [etapes]);

            const moveEtapeDown = useCallback((index) => {
                if (index < etapes.length - 1) {
                    const newEtapes = [...etapes];
                    [newEtapes[index], newEtapes[index + 1]] = [newEtapes[index + 1], newEtapes[index]];
                    setEtapes(newEtapes);
                    console.log('Déplacé vers le bas:', index);
                }
            }, [etapes]);

            const toggleParallel = useCallback((index) => {
                const newEtapes = [...etapes];
                const etape = newEtapes[index];
                
                if (etape.isParallel) {
                    etape.isParallel = false;
                    delete etape.parallelToStep;
                    setShowParallelSelector(null);
                } else {
                    setShowParallelSelector(index);
                }
                
                setEtapes(newEtapes);
            }, [etapes]);

            const setParallelToStep = useCallback((etapeIndex, parallelToStepNumber) => {
                const newEtapes = [...etapes];
                newEtapes[etapeIndex].isParallel = true;
                newEtapes[etapeIndex].parallelToStep = parallelToStepNumber;
                setEtapes(newEtapes);
                setShowParallelSelector(null);
            }, [etapes]);

            return React.createElement('div', { className: 'p-6' },
                React.createElement('h1', { className: 'text-2xl mb-4' }, 'Test Debug - Interface Étapes'),
                React.createElement('div', { className: 'space-y-3' },
                    etapes.map((etape, index) => 
                        React.createElement('div', {
                            key: index,
                            className: 'border rounded-lg p-3 bg-gray-50'
                        },
                            React.createElement('div', { className: 'flex items-start gap-3' },
                                // Numéro d'étape
                                React.createElement('div', { 
                                    className: `w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold`,
                                }, index + 1),
                                
                                // Contenu
                                React.createElement('div', { className: 'flex-1' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: etape.text,
                                        onChange: (e) => {
                                            const newEtapes = [...etapes];
                                            newEtapes[index].text = e.target.value;
                                            setEtapes(newEtapes);
                                        },
                                        className: 'w-full p-2 border rounded'
                                    }),
                                    React.createElement('div', { className: 'flex gap-2 mt-2' },
                                        React.createElement('input', {
                                            type: 'checkbox',
                                            checked: etape.isParallel || false,
                                            onChange: () => toggleParallel(index)
                                        }),
                                        React.createElement('span', null, 'Parallèle'),
                                        etape.isParallel && React.createElement('span', { 
                                            className: 'bg-yellow-200 px-2 rounded' 
                                        }, `→ Étape ${etape.parallelToStep}`)
                                    )
                                ),
                                
                                // Boutons de contrôle
                                React.createElement('div', { className: 'flex flex-col gap-1' },
                                    React.createElement('button', {
                                        onClick: () => moveEtapeUp(index),
                                        disabled: index === 0,
                                        className: 'w-8 h-8 bg-blue-100 rounded disabled:opacity-50'
                                    }, '⬆️'),
                                    React.createElement('button', {
                                        onClick: () => moveEtapeDown(index),
                                        disabled: index === etapes.length - 1,
                                        className: 'w-8 h-8 bg-blue-100 rounded disabled:opacity-50'
                                    }, '⬇️')
                                )
                            ),
                            
                            // Sélecteur parallèle
                            showParallelSelector === index && React.createElement('div', { 
                                className: 'mt-3 p-3 bg-yellow-100 rounded' 
                            },
                                React.createElement('p', { className: 'mb-2' }, 'En parallèle de quelle étape ?'),
                                React.createElement('div', { className: 'flex gap-2' },
                                    etapes.map((_, etapeIndex) => {
                                        if (etapeIndex === index) return null;
                                        return React.createElement('button', {
                                            key: etapeIndex,
                                            onClick: () => setParallelToStep(index, etapeIndex + 1),
                                            className: 'px-3 py-1 bg-blue-200 rounded'
                                        }, `Étape ${etapeIndex + 1}`);
                                    })
                                ),
                                React.createElement('button', {
                                    onClick: () => setShowParallelSelector(null),
                                    className: 'mt-2 text-sm text-gray-600'
                                }, 'Annuler')
                            )
                        )
                    )
                )
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('app'));
            root.render(React.createElement(TestApp));
            console.log('Test app rendu avec succès');
        } catch (error) {
            document.getElementById('error-log').innerHTML = `<div style="background: red; color: white; padding: 10px;">
                ERREUR DE RENDU: ${error.message}<br>
                ${error.stack}
            </div>`;
        }
    </script>
</body>
</html>